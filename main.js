const TAG_DATA = {
    "体位・プレイ": {
        "基本一覧": [
            { nameJa: "正常位", desc: "missionary", value: "missionary" },
            { nameJa: "女が馬乗り/逆正常位", desc: "girl on top, cowgirl", value: "cowgirl position" },
            { nameJa: "背面騎乗位", desc: "reverse cowgirl", value: "reverse cowgirl position" },
            { nameJa: "側位", desc: "spooning", value: "spooning" },
            { nameJa: "対面座位", desc: "upright straddle", value: "upright straddle" },
            { nameJa: "逆背面座位", desc: "reverse upright straddle", value: "reverse upright straddle" },
            { nameJa: "対面体位 / 立ちバック", desc: "standing sex", value: "standing sex" },
            { nameJa: "まんぐり返し", desc: "folded, legs up", value: "folded, legs up" },
            { nameJa: "奥まで挿入", desc: "deep penetration", value: "deep penetration" },
            { nameJa: "松葉崩し", desc: "prone bone / on side", value: "prone bone" },
            { nameJa: "だいしゅきホールド", desc: "leg lock", value: "leg lock" },
            { nameJa: "種付けプレス", desc: "mating press", value: "mating press" },
            { nameJa: "おまんこサンドイッチ", desc: "pussy sandwich", value: "pussy sandwich" },
            { nameJa: "駅弁", desc: "suspended congress", value: "suspended congress" },
            { nameJa: "アナル固め / 逆駅弁", desc: "reverse suspended congress", value: "reverse suspended congress" },
            { nameJa: "女体盛", desc: "nyotaimori", value: "nyotaimori" },
            { nameJa: "体の上に食べ物", desc: "food on body", value: "food on body" },
            { nameJa: "胸の上に食べ物", desc: "food on breasts", value: "food on breasts" },
            { nameJa: "一部水中構図", desc: "partially underwater", value: "partially underwater shot" }
        ],
        "乳系プレイ": [
            { nameJa: "ぱふぱふ", desc: "head between breasts", value: "head between breasts" },
            { nameJa: "顔をうずめる", desc: "face to breasts", value: "face to breasts" },
            { nameJa: "顔の上に乳をのせる", desc: "breast smother", value: "breast smother" },
            { nameJa: "乳枕", desc: "breast pillow", value: "breast pillow" },
            { nameJa: "揉ませてる", desc: "guided breast grab", value: "guided breast grab" },
            { nameJa: "チョコパイ", desc: "chocolate on breasts", value: "chocolate on breasts" },
            { nameJa: "乳見せ", desc: "presenting breasts", value: "presenting breasts" },
            { nameJa: "乳首ズリ", desc: "penis to breast", value: "penis to breast" },
            { nameJa: "乳舐め", desc: "licking breast", value: "licking breast" },
            { nameJa: "乳に噛み跡", desc: "bite mark on breast", value: "bite mark on breast" },
            { nameJa: "乳を突く", desc: "poking breast", value: "poking another's breast" }
        ],
        "二人": [
            { nameJa: "男女", desc: "hetero", value: "hetero" },
            { nameJa: "女女", desc: "yuri", value: "yuri" },
            { nameJa: "男男", desc: "bara", value: "bara" },
            { nameJa: "BL/腐", desc: "yaoi", value: "yaoi" },
            { nameJa: "女＋ふたなり", desc: "futa with female", value: "futa with female" },
            { nameJa: "男＋ふたなり", desc: "futa with male", value: "futa with male" },
            { nameJa: "おねロリ", desc: "onee-loli", value: "onee-loli, age difference" },
            { nameJa: "おねショタ", desc: "onee-shota", value: "onee-shota, age difference" },
            { nameJa: "おにショタ", desc: "onii-shota", value: "onii-shota, age difference" },
            { nameJa: "子供同士", desc: "kodomo doushi", value: "kodomo doushi" }
        ],
        "複数人": [
            { nameJa: "3P(女女男)", desc: "ffm threesome", value: "ffm threesome" },
            { nameJa: "3P(女男男)", desc: "mmf threesome", value: "mmf threesome" },
            { nameJa: "4P, 5P, 乱交", desc: "group sex", value: "group sex" },
            { nameJa: "複数人がセックス", desc: "orgy", value: "orgy" },
            { nameJa: "輪姦/集団", desc: "gangbang", value: "gangbang" },
            { nameJa: "親子丼", desc: "oyakodon", value: "oyakodon (sex), mother and daughter" },
            { nameJa: "姉妹丼", desc: "shimaidon", value: "shimaidon (sex)" }
        ],
        "ポーズ": [
            { nameJa: "I 字バランス", desc: "standing split", value: "standing split" },
            { nameJa: "ガニ股", desc: "bowlegged", value: "bowlegged pose" },
            { nameJa: "膝立ち", desc: "kneeling", value: "kneeling" },
            { nameJa: "前屈み", desc: "leaning forward", value: "leaning forward" },
            { nameJa: "より深い前屈み", desc: "bent over", value: "bent over" },
            { nameJa: "蹲踞", desc: "squatting", value: "squatting" },
            { nameJa: "女の子座り", desc: "wariza", value: "wariza" },
            { nameJa: "馬乗り", desc: "straddling", value: "straddling" },
            { nameJa: "四つん這い", desc: "all fours", value: "all fours" },
            { nameJa: "尻突き出し/頭下げ", desc: "top-down bottom-up", value: "top-down bottom-up" },
            { nameJa: "両脚上げ", desc: "knees up", value: "knees up" },
            { nameJa: "膝かかえ", desc: "knee up", value: "knee up" },
            { nameJa: "正座", desc: "seiza", value: "seiza" },
            { nameJa: "逆さ吊り", desc: "upside-down", value: "upside-down" },
            { nameJa: "横座り", desc: "yokozuwari", value: "yokozuwari" },
            { nameJa: "あぐら", desc: "indian style", value: "indian style" },
            { nameJa: "体育座り", desc: "hugging own legs", value: "hugging own legs" },
            { nameJa: "M字開脚", desc: "m legs", value: "m legs" },
            { nameJa: "内股", desc: "pigeon-toed", value: "pigeon-toed" },
            { nameJa: "もたれかかる", desc: "reclining", value: "reclining" },
            { nameJa: "仰向け", desc: "on back", value: "on back" },
            { nameJa: "うつ伏せ", desc: "on stomach", value: "on stomach" },
            { nameJa: "人の上に寝ている", desc: "lying on person", value: "lying on person" },
            { nameJa: "脚の上に座る", desc: "sitting on lap", value: "sitting on lap" },
            { nameJa: "膝枕", desc: "lap pillow", value: "lap pillow" },
            { nameJa: "手ブラ", desc: "covering breasts", value: "covering breasts" }
        ]
    },
    "エロ衣装": {
        "全身": [
            { nameJa: "レオタード", desc: "leotard", value: "leotard" },
            { nameJa: "ボディースーツ", desc: "bodysuit", value: "bodysuit" },
            { nameJa: "ビキニ", desc: "bikini", value: "bikini" },
            { nameJa: "マイクロビキニ", desc: "micro bikini", value: "micro bikini" },
            { nameJa: "襷ブラ", desc: "pretzel bikini", value: "pretzel bikini" },
            { nameJa: "スク水", desc: "school swimsuit", value: "school swimsuit" },
            { nameJa: "競泳水着", desc: "competition swimsuit", value: "competition swimsuit" },
            { nameJa: "セーター", desc: "sweater", value: "sweater" },
            { nameJa: "童貞を殺すセーター", desc: "virgin killer", value: "virgin killer sweater" },
            { nameJa: "緊縛/ボンデージ", desc: "bondage", value: "bondage" },
            { nameJa: "ネグリジェ", desc: "nightgown", value: "nightgown" },
            { nameJa: "ランジェリー", desc: "lingerie", value: "lingerie" },
            { nameJa: "バニーガール", desc: "playboy bunny", value: "playboy bunny" },
            { nameJa: "逆バニー", desc: "reverse bunnysuit", value: "reverse bunnysuit" },
            { nameJa: "魚網/シースルー", desc: "fishnets", value: "fishnets" },
            { nameJa: "コルセット", desc: "corset", value: "corset" },
            { nameJa: "全身タイツ", desc: "bodystocking", value: "bodystocking" },
            { nameJa: "ラバー/ラテックス", desc: "latex", value: "latex" }
        ],
        "上半身": [
            { nameJa: "ブラジャー", desc: "bra", value: "bra" },
            { nameJa: "ニップレス", desc: "pasties", value: "pasties" },
            { nameJa: "トップレス", desc: "topless", value: "topless female" },
            { nameJa: "キャミソール", desc: "camisole", value: "camisole" },
            { nameJa: "目隠し", desc: "blindfold", value: "blindfold" },
            { nameJa: "猿轡/ギャグ", desc: "gag", value: "gag" },
            { nameJa: "乳強調服", desc: "framed breasts", value: "framed breasts" },
            { nameJa: "乳首カットアウト", desc: "breast cutout", value: "breast cutout" }
        ],
        "下半身": [
            { nameJa: "ショーツ/パンティ", desc: "panties", value: "panties" },
            { nameJa: "縞パン", desc: "striped panties", value: "striped panties" },
            { nameJa: "Tバック", desc: "thong", value: "thong" },
            { nameJa: "紐パン", desc: "string panties", value: "string panties" },
            { nameJa: "オープンクロッチ", desc: "crotchless", value: "crotchless panties" },
            { nameJa: "ガーターベルト", desc: "garter belt", value: "garter belt" },
            { nameJa: "ニーハイ", desc: "thighhighs", value: "thighhighs" },
            { nameJa: "前貼り", desc: "maebari", value: "maebari" }
        ]
    },
    "男": {
        "基本": [
            { nameJa: "マッチョ", desc: "muscular male", value: "muscular male" },
            { nameJa: "おじさん", desc: "mature male", value: "mature male" },
            { nameJa: "アグリーバスタード", desc: "ugly bastard", value: "ugly bastard" },
            { nameJa: "カオナシ", desc: "faceless male", value: "faceless male" }
        ],
        "ペニス": [
            { nameJa: "ペニス", desc: "penis", value: "penis" },
            { nameJa: "勃起", desc: "erection", value: "erection" },
            { nameJa: "包茎", desc: "foreskin", value: "foreskin" }
        ]
    },
    "液体": {
        "精液": [
            { nameJa: "精液", desc: "cum", value: "cum" },
            { nameJa: "中出し", desc: "cum in pussy", value: "cum in pussy" },
            { nameJa: "ガマン汁", desc: "precum", value: "precum" },
            { nameJa: "ザーメンブリッジ", desc: "cum string", value: "cum string" }
        ],
        "愛液": [
            { nameJa: "愛液", desc: "pussy juice", value: "pussy juice" },
            { nameJa: "愛液跡", desc: "pussy juice stain", value: "pussy juice stain" }
        ],
        "おしっこ": [
            { nameJa: "放尿", desc: "peeing", value: "peeing" },
            { nameJa: "おもらし", desc: "peeing self", value: "peeing self" }
        ]
    },
    "その他": {
        "ハンドサイン": [
            { nameJa: "貫通サイン", desc: "penetration gesture", value: "penetration gesture" },
            { nameJa: "エア手コキ", desc: "handjob gesture", value: "handjob gesture" },
            { nameJa: "エアフェラ", desc: "fellatio gesture", value: "fellatio gesture" },
            { nameJa: "ピース", desc: "v", value: "v" },
            { nameJa: "ダブルピース", desc: "double v", value: "double v" },
            { nameJa: "手でハート", desc: "heart hands", value: "heart hands" }
        ],
        "触手": [
            { nameJa: "触手", desc: "tentacles", value: "tentacles" },
            { nameJa: "触手姦", desc: "tentacle sex", value: "tentacle sex" }
        ],
        "淫紋": [
            { nameJa: "淫紋", desc: "pubic tattoo", value: "pubic tattoo" }
        ],
        "バイブ・ディルド": [
            { nameJa: "バイブ", desc: "vibrator", value: "vibrator" },
            { nameJa: "ディルド", desc: "dildo", value: "dildo" },
            { nameJa: "異物挿入", desc: "object insertion", value: "vaginal object insertion" }
        ],
        "服": [
            { nameJa: "食い込み", desc: "skindentation", value: "skindentation" },
            { nameJa: "ブラチラ/パンチラ", desc: "peek", value: "bra peek" }
        ],
        "拘束": [
            { nameJa: "首輪", desc: "collar", value: "collar" },
            { nameJa: "手錠", desc: "handcuffs", value: "handcuffs" },
            { nameJa: "束縛", desc: "bound", value: "bound wrists" }
        ],
        "表情": [
            { nameJa: "オホ顔", desc: "puckered lips", value: "puckered lips, rolling eyes" },
            { nameJa: "首絞め", desc: "strangling", value: "strangling" },
            { nameJa: "断面図", desc: "x-ray", value: "x-ray" },
            { nameJa: "痙攣", desc: "twitching", value: "twitching" }
        ]
    },
    "部位": {
        "女性器": [
            { nameJa: "女性器", desc: "pussy", value: "pussy" },
            { nameJa: "マンスジ", desc: "cleft of venus", value: "cleft of venus" },
            { nameJa: "陰毛", desc: "pubic hair", value: "pubic hair" },
            { nameJa: "くぱぁ", desc: "spread pussy", value: "spread pussy" }
        ],
        "アヌス": [
            { nameJa: "アヌス", desc: "anus", value: "anus" },
            { nameJa: "アナル(挿入)", desc: "anal", value: "anal" }
        ],
        "腹": [
            { nameJa: "シックスパック", desc: "abs", value: "abs" },
            { nameJa: "イカ腹/へそ出し", desc: "midriff", value: "midriff" }
        ],
        "尻": [
            { nameJa: "デカ尻", desc: "wide hip", value: "wide hip" },
            { nameJa: "半ケツ", desc: "butt crack", value: "butt crack" },
            { nameJa: "下尻", desc: "underbutt", value: "underbutt" }
        ],
        "乳": [
            { nameJa: "垂れ乳", desc: "sagging breasts", value: "sagging breasts" },
            { nameJa: "乳揺れ", desc: "bouncing breasts", value: "bouncing breasts" },
            { nameJa: "パイスラ", desc: "strap between breasts", value: "strap between breasts" }
        ],
        "乳首/ピアス": [
            { nameJa: "乳首", desc: "nipples", value: "nipples" },
            { nameJa: "陥没乳首", desc: "inverted nipples", value: "inverted nipples" },
            { nameJa: "乳首ピアス", desc: "nipple piercing", value: "nipple piercing" }
        ],
        "乳動作": [
            { nameJa: "胸を揉む", desc: "grabbing breast", value: "grabbing another's breast" },
            { nameJa: "乳挟み", desc: "between breasts", value: "between breasts" },
            { nameJa: "乳押し付け", desc: "breast press", value: "breast press" }
        ],
        "肩/腕": [
            { nameJa: "肩出し", desc: "bare shoulders", value: "bare shoulders" },
            { nameJa: "脇見せ", desc: "arms up", value: "arms up" },
            { nameJa: "後ろ手縛り", desc: "arms behind back", value: "arms behind back" }
        ]
    },
    "撮影": {
        "アングル": [
            { nameJa: "真正面", desc: "straight-on", value: "straight-on" },
            { nameJa: "後ろから", desc: "from behind", value: "from behind" },
            { nameJa: "真横から", desc: "from side", value: "from side" },
            { nameJa: "ハイアングル", desc: "from above", value: "from above" },
            { nameJa: "ローアングル", desc: "from below", value: "from below" },
            { nameJa: "主観視点", desc: "pov", value: "pov" }
        ],
        "画角": [
            { nameJa: "顔アップ", desc: "close-up", value: "close-up" },
            { nameJa: "上半身", desc: "upper body", value: "upper body" },
            { nameJa: "全身", desc: "full body", value: "full body" }
        ],
        "ライティング": [
            { nameJa: "逆光", desc: "backlighting", value: "backlighting" },
            { nameJa: "サイド光", desc: "sidelighting", value: "sidelighting" },
            { nameJa: "シネマティック", desc: "cinematic", value: "cinematic lighting" },
            { nameJa: "ボケ", desc: "bokeh", value: "bokeh" }
        ]
    }
};

let selectedTags = new Set();
let currentMainCategory = '体位・プレイ';
let currentSubCategory = '';
let searchQuery = '';

const tagContainer = document.getElementById('tag-container');
const subTabContainer = document.getElementById('sub-category-tabs');
const promptDisplay = document.getElementById('prompt-display');
const copyBtn = document.getElementById('copy-btn');
const clearBtn = document.getElementById('clear-btn');
const tabBtns = document.querySelectorAll('.tab-btn');
const searchInput = document.getElementById('tag-search');
const copyNegBtn = document.getElementById('copy-neg-btn');
const negPromptText = document.getElementById('negative-prompt-text');

// Initialize
function init() {
    renderSubTabs();
    renderRows();
    setupEventListeners();
}

function renderSubTabs() {
    subTabContainer.innerHTML = '';
    const subCats = Object.keys(TAG_DATA[currentMainCategory]);

    // Set default subcategory if none selected or if switching main category
    if (!currentSubCategory || !TAG_DATA[currentMainCategory][currentSubCategory]) {
        currentSubCategory = subCats[0];
    }

    subCats.forEach(sub => {
        const btn = document.createElement('button');
        btn.className = `sub-tab-btn ${sub === currentSubCategory ? 'active' : ''}`;
        btn.textContent = sub;
        btn.onclick = () => {
            currentSubCategory = sub;
            renderSubTabs();
            renderRows();
        };
        subTabContainer.appendChild(btn);
    });
}

function renderRows() {
    tagContainer.innerHTML = '';

    // Get tags from current sub-category or filter all in main category if searching
    let tagsToShow = [];
    if (searchQuery) {
        // Search across ALL sub-categories in current main category
        Object.values(TAG_DATA[currentMainCategory]).forEach(subTags => {
            tagsToShow = tagsToShow.concat(subTags);
        });
    } else {
        tagsToShow = TAG_DATA[currentMainCategory][currentSubCategory] || [];
    }

    const filteredTags = tagsToShow.filter(tag =>
        tag.nameJa.includes(searchQuery) ||
        tag.value.toLowerCase().includes(searchQuery.toLowerCase()) ||
        tag.desc.includes(searchQuery)
    );

    if (filteredTags.length === 0) {
        tagContainer.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 2rem; color: var(--text-muted);">見つかりませんでした</td></tr>';
        return;
    }

    // Deduplicate if searching (though mostly shouldn't be needed)
    const uniqueTags = Array.from(new Set(filteredTags.map(t => t.value)))
        .map(val => filteredTags.find(t => t.value === val));

    uniqueTags.forEach(tag => {
        const tr = document.createElement('tr');
        if (selectedTags.has(tag.value)) tr.classList.add('selected');

        const isChecked = selectedTags.has(tag.value) ? 'checked' : '';

        tr.innerHTML = `
            <td class="col-name">
                <label class="checkbox-container">
                    <input type="checkbox" data-value="${tag.value}" ${isChecked}>
                    <span class="checkmark"></span>
                    ${tag.nameJa}
                </label>
            </td>
            <td class="col-desc">${tag.desc}</td>
            <td class="col-tag">${tag.value}</td>
        `;

        tr.onclick = (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL' && e.target.className !== 'checkmark') {
                const checkbox = tr.querySelector('input');
                checkbox.checked = !checkbox.checked;
                toggleTag(tag.value, checkbox.checked);
            }
        };

        const checkbox = tr.querySelector('input');
        checkbox.onchange = (e) => {
            toggleTag(tag.value, e.target.checked);
        };

        tagContainer.appendChild(tr);
    });
}

function toggleTag(value, isChecked) {
    if (isChecked) {
        selectedTags.add(value);
    } else {
        selectedTags.delete(value);
    }
    updatePrompt();

    const rows = tagContainer.querySelectorAll('tr');
    rows.forEach(row => {
        const checkbox = row.querySelector('input');
        if (checkbox && checkbox.dataset.value === value) {
            if (isChecked) row.classList.add('selected');
            else row.classList.remove('selected');
        }
    });
}

function updatePrompt() {
    if (selectedTags.size === 0) {
        promptDisplay.innerHTML = '<span class="placeholder">下のテーブルから項目を選択してプロンプトを作成してください...</span>';
        return;
    }
    const promptArray = Array.from(selectedTags);
    promptDisplay.textContent = promptArray.join(', ');
}

function setupEventListeners() {
    // Main Tabs
    tabBtns.forEach(btn => {
        btn.onclick = () => {
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMainCategory = btn.dataset.category;
            currentSubCategory = ''; // Reset sub-category
            renderSubTabs();
            renderRows();
        };
    });

    // Search
    searchInput.oninput = (e) => {
        searchQuery = e.target.value;
        renderRows();
    };

    // Copy Prompt
    copyBtn.onclick = () => {
        const text = promptDisplay.textContent;
        if (selectedTags.size > 0 && !text.includes('下のテーブルから')) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'コピー完了！';
                copyBtn.classList.add('success');
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('success');
                }, 2000);
            });
        }
    };

    // Clear All
    clearBtn.onclick = () => {
        selectedTags.clear();
        updatePrompt();
        renderRows();
    };

    // Copy Negative Prompt
    copyNegBtn.onclick = () => {
        navigator.clipboard.writeText(negPromptText.textContent).then(() => {
            copyNegBtn.textContent = 'コピー完了！';
            setTimeout(() => {
                copyNegBtn.textContent = 'Copy';
            }, 2000);
        });
    };
}

init();
