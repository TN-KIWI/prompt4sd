const TAG_DATA = {
    general: {
        "クオリティ": [
            { nameJa: "傑作", desc: "クオリティを底上げ", value: "masterpiece" },
            { nameJa: "最高品質", desc: "ディテール向上", value: "best quality" },
            { nameJa: "高解像度", desc: "きめ細やかな描写", value: "highres" },
            { nameJa: "8K解像度", desc: "精細な壁紙品質", value: "8k wallpaper" },
            { nameJa: "超詳細", desc: "細部まで描き込む", value: "ultra-detailed" }
        ],
        "カメラ/アングル": [
            { nameJa: "真正面", desc: "straight-on", value: "straight-on" },
            { nameJa: "後ろ", desc: "from behind", value: "from behind" },
            { nameJa: "真横", desc: "from side", value: "from side" },
            { nameJa: "ハイアングル", desc: "from above", value: "from above" },
            { nameJa: "ローアングル", desc: "from below", value: "from below" },
            { nameJa: "広角ショット", desc: "wide shot", value: "wide shot" },
            { nameJa: "俯瞰", desc: "birds eye view", value: "birds eye view" },
            { nameJa: "斜め構図", desc: "dutch angle", value: "dutch angle" },
            { nameJa: "魚眼レンズ", desc: "fisheye", value: "fisheye" }
        ],
        "画角/構成": [
            { nameJa: "顔アップ", desc: "close-up", value: "close-up" },
            { nameJa: "ポートレート", desc: "portrait", value: "portrait" },
            { nameJa: "上半身", desc: "upper body", value: "upper body" },
            { nameJa: "膝上", desc: "cowboy shot", value: "cowboy shot" },
            { nameJa: "全身", desc: "full body", value: "full body" }
        ],
        "照明/効果": [
            { nameJa: "シネマティック", desc: "cinematic lighting", value: "cinematic lighting" },
            { nameJa: "逆光", desc: "backlighting", value: "backlighting" },
            { nameJa: "サイド照明", desc: "sidelighting", value: "sidelighting" },
            { nameJa: "レンズフレア", desc: "lens flare", value: "lens flare" },
            { nameJa: "周辺減光", desc: "vignetting", value: "vignetting" },
            { nameJa: "色収差", desc: "chromatic aberration", value: "chromatic aberration" }
        ]
    },
    position: {
        "体位(一般)": [
            { nameJa: "正常位", desc: "missionary", value: "missionary" },
            { nameJa: "騎乗位", desc: "cowgirl position", value: "cowgirl position" },
            { nameJa: "背面騎乗位", desc: "reverse cowgirl position", value: "reverse cowgirl position" },
            { nameJa: "側位", desc: "spooning", value: "spooning" },
            { nameJa: "対面座位", desc: "upright straddle", value: "upright straddle" },
            { nameJa: "立ちバック", desc: "standing sex", value: "standing sex" },
            { nameJa: "だいしゅきホールド", desc: "leg lock", value: "leg lock" },
            { nameJa: "種付けプレス", desc: "mating press", value: "mating press" },
            { nameJa: "駅弁", desc: "suspended congress", value: "suspended congress" }
        ],
        "ポーズ": [
            { nameJa: "膝立ち", desc: "kneeling", value: "kneeling" },
            { nameJa: "四つん這い", desc: "all fours", value: "all fours" },
            { nameJa: "M字開脚", desc: "m legs", value: "m legs" },
            { nameJa: "I 字バランス", desc: "standing split", value: "standing split" },
            { nameJa: "割座", desc: "wariza", value: "wariza" },
            { nameJa: "あぐら", desc: "indian style", value: "indian style" },
            { nameJa: "蹲踞", desc: "squatting", value: "squatting" },
            { nameJa: "体育座り", desc: "hugging own legs", value: "hugging own legs" }
        ],
        "複数人": [
            { nameJa: "男女", desc: "hetero", value: "hetero" },
            { nameJa: "女女", desc: "yuri", value: "yuri" },
            { nameJa: "3P(女女男)", desc: "ffm threesome", value: "ffm threesome" },
            { nameJa: "3P(女男男)", desc: "mmf threesome", value: "mmf threesome" },
            { nameJa: "グループ", desc: "group sex", value: "group sex" },
            { nameJa: "乱交", desc: "orgy", value: "orgy" },
            { nameJa: "輪姦", desc: "gangbang", value: "gangbang" }
        ],
        "非挿入系": [
            { nameJa: "素股", desc: "grinding", value: "grinding" },
            { nameJa: "太ももコキ", desc: "thigh sex", value: "thigh sex" },
            { nameJa: "貝合わせ", desc: "tribadism", value: "tribadism" },
            { nameJa: "手コキ", desc: "handjob", value: "handjob" },
            { nameJa: "オナニー", desc: "female masturbation", value: "female masturbation" }
        ]
    },
    clothing: {
        "全身衣装": [
            { nameJa: "レオタード", desc: "leotard", value: "leotard" },
            { nameJa: "ボディースーツ", desc: "bodysuit", value: "bodysuit" },
            { nameJa: "ビキニ", desc: "bikini", value: "bikini" },
            { nameJa: "マイクロビキニ", desc: "micro bikini", value: "micro bikini" },
            { nameJa: "スク水", desc: "school swimsuit", value: "school swimsuit" },
            { nameJa: "バニーガール", desc: "playboy bunny", value: "playboy bunny" },
            { nameJa: "ベビードール", desc: "babydoll", value: "babydoll" },
            { nameJa: "全身タイツ", desc: "bodystocking", value: "bodystocking" }
        ],
        "上半身": [
            { nameJa: "ブラジャー", desc: "bra", value: "bra" },
            { nameJa: "スポブラ", desc: "sports bra", value: "sports bra" },
            { nameJa: "ニップレス", desc: "pasties", value: "pasties" },
            { nameJa: "キャミソール", desc: "camisole", value: "camisole" },
            { nameJa: "トップレス", desc: "topless female", value: "topless female" }
        ],
        "下半身": [
            { nameJa: "ショーツ", desc: "panties", value: "panties" },
            { nameJa: "縞パン", desc: "striped panties", value: "striped panties" },
            { nameJa: "Tバック", desc: "thong", value: "thong" },
            { nameJa: "オープンクロッチ", desc: "crotchless panties", value: "crotchless panties" },
            { nameJa: "ニーハイ", desc: "thighhighs", value: "thighhighs" },
            { nameJa: "ガーターベルト", desc: "garter belt", value: "garter belt" }
        ],
        "拘束/装備": [
            { nameJa: "首輪", desc: "collar", value: "collar" },
            { nameJa: "手錠", desc: "handcuffs", value: "handcuffs" },
            { nameJa: "目隠し", desc: "blindfold", value: "blindfold" },
            { nameJa: "猿轡", desc: "gag", value: "gag" },
            { nameJa: "バイブ", desc: "vibrator", value: "vibrator" },
            { nameJa: "アナルプラグ", desc: "butt plug", value: "butt plug" }
        ]
    },
    body: {
        "性器": [
            { nameJa: "女性器", desc: "pussy", value: "pussy" },
            { nameJa: "くぱぁ", desc: "spread pussy", value: "spread pussy" },
            { nameJa: "陰毛", desc: "pubic hair", value: "pubic hair" },
            { nameJa: "アヌス", desc: "anus", value: "anus" },
            { nameJa: "ペニス", desc: "penis", value: "penis" }
        ],
        "乳/胸": [
            { nameJa: "乳", desc: "breasts", value: "breasts" },
            { nameJa: "乳首", desc: "nipples", value: "nipples" },
            { nameJa: "垂れ乳", desc: "sagging breasts", value: "sagging breasts" },
            { nameJa: "乳揺れ", desc: "bouncing breasts", value: "bouncing breasts" },
            { nameJa: "乳首ピアス", desc: "nipple piercing", value: "nipple piercing" }
        ],
        "尻/脚/腰": [
            { nameJa: "尻", desc: "ass", value: "ass" },
            { nameJa: "デカ尻", desc: "wide hip", value: "wide hip" },
            { nameJa: "腹筋", desc: "abs", value: "abs" },
            { nameJa: "腰", desc: "waist", value: "waist" },
            { nameJa: "太もも", desc: "thighs", value: "thighs" }
        ],
        "表情/顔": [
            { nameJa: "微笑み", desc: "smiling", value: "smiling" },
            { nameJa: "照れ顔", desc: "blushing", value: "blushing" },
            { nameJa: "アヘ顔", desc: "ahegao", value: "ahegao" },
            { nameJa: "オホ顔", desc: "puckered lips, rolling eyes", value: "puckered lips, rolling eyes" },
            { nameJa: "舌出し", desc: "tongue out", value: "tongue out" }
        ]
    },
    action: {
        "行為/プレイ": [
            { nameJa: "フェラ", desc: "fellatio", value: "fellatio" },
            { nameJa: "イラマチオ", desc: "irrumatio", value: "irrumatio" },
            { nameJa: "ディープスロート", desc: "deepthroat", value: "deepthroat" },
            { nameJa: "ぱふぱふ", desc: "head between breasts", value: "head between breasts" },
            { nameJa: "首絞め", desc: "strangling", value: "strangling" }
        ],
        "分泌液": [
            { nameJa: "精液", desc: "cum", value: "cum" },
            { nameJa: "中出し", desc: "cum in pussy", value: "cum in pussy" },
            { nameJa: "ガマン汁", desc: "precum", value: "precum" },
            { nameJa: "愛液", desc: "pussy juice", value: "pussy juice" },
            { nameJa: "放尿", desc: "peeing", value: "peeing" }
        ],
        "特殊": [
            { nameJa: "受精", desc: "impregnation", value: "impregnation" },
            { nameJa: "断面図", desc: "x-ray", value: "x-ray" },
            { nameJa: "触手", desc: "tentacles", value: "tentacles" },
            { nameJa: "淫紋", desc: "pubic tattoo", value: "pubic tattoo" }
        ]
    },
    scene: {
        "室内": [
            { nameJa: "室内", desc: "indoors", value: "indoors" },
            { nameJa: "教室", desc: "classroom", value: "classroom" },
            { nameJa: "カフェ", desc: "cafe", value: "cafe" },
            { nameJa: "寝室", desc: "bedroom", value: "bedroom" }
        ],
        "屋外": [
            { nameJa: "屋外", desc: "outdoors", value: "outdoors" },
            { nameJa: "ビーチ", desc: "beach", value: "beach" },
            { nameJa: "森", desc: "forest", value: "forest" },
            { nameJa: "夜空", desc: "night sky", value: "night sky" }
        ]
    }
};

let selectedTags = new Set();
let currentMainCategory = 'general';
let currentSubCategory = '';
let searchQuery = '';

const tagContainer = document.getElementById('tag-container');
const subTabContainer = document.getElementById('sub-category-tabs');
const promptDisplay = document.getElementById('prompt-display');
const copyBtn = document.getElementById('copy-btn');
const clearBtn = document.getElementById('clear-btn');
const tabBtns = document.querySelectorAll('.tab-btn');
const searchInput = document.getElementById('tag-search');
const copyNegBtn = document.getElementById('copy-neg-btn');
const negPromptText = document.getElementById('negative-prompt-text');

// Initialize
function init() {
    renderSubTabs();
    renderRows();
    setupEventListeners();
}

function renderSubTabs() {
    subTabContainer.innerHTML = '';
    const subCats = Object.keys(TAG_DATA[currentMainCategory]);

    // Set default subcategory if none selected or if switching main category
    if (!currentSubCategory || !TAG_DATA[currentMainCategory][currentSubCategory]) {
        currentSubCategory = subCats[0];
    }

    subCats.forEach(sub => {
        const btn = document.createElement('button');
        btn.className = `sub-tab-btn ${sub === currentSubCategory ? 'active' : ''}`;
        btn.textContent = sub;
        btn.onclick = () => {
            currentSubCategory = sub;
            renderSubTabs();
            renderRows();
        };
        subTabContainer.appendChild(btn);
    });
}

function renderRows() {
    tagContainer.innerHTML = '';

    // Get tags from current sub-category or filter all in main category if searching
    let tagsToShow = [];
    if (searchQuery) {
        // Search across ALL sub-categories in current main category
        Object.values(TAG_DATA[currentMainCategory]).forEach(subTags => {
            tagsToShow = tagsToShow.concat(subTags);
        });
    } else {
        tagsToShow = TAG_DATA[currentMainCategory][currentSubCategory] || [];
    }

    const filteredTags = tagsToShow.filter(tag =>
        tag.nameJa.includes(searchQuery) ||
        tag.value.toLowerCase().includes(searchQuery.toLowerCase()) ||
        tag.desc.includes(searchQuery)
    );

    if (filteredTags.length === 0) {
        tagContainer.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 2rem; color: var(--text-muted);">見つかりませんでした</td></tr>';
        return;
    }

    // Deduplicate if searching (though mostly shouldn't be needed)
    const uniqueTags = Array.from(new Set(filteredTags.map(t => t.value)))
        .map(val => filteredTags.find(t => t.value === val));

    uniqueTags.forEach(tag => {
        const tr = document.createElement('tr');
        if (selectedTags.has(tag.value)) tr.classList.add('selected');

        const isChecked = selectedTags.has(tag.value) ? 'checked' : '';

        tr.innerHTML = `
            <td class="col-name">
                <label class="checkbox-container">
                    <input type="checkbox" data-value="${tag.value}" ${isChecked}>
                    <span class="checkmark"></span>
                    ${tag.nameJa}
                </label>
            </td>
            <td class="col-desc">${tag.desc}</td>
            <td class="col-tag">${tag.value}</td>
        `;

        tr.onclick = (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL' && e.target.className !== 'checkmark') {
                const checkbox = tr.querySelector('input');
                checkbox.checked = !checkbox.checked;
                toggleTag(tag.value, checkbox.checked);
            }
        };

        const checkbox = tr.querySelector('input');
        checkbox.onchange = (e) => {
            toggleTag(tag.value, e.target.checked);
        };

        tagContainer.appendChild(tr);
    });
}

function toggleTag(value, isChecked) {
    if (isChecked) {
        selectedTags.add(value);
    } else {
        selectedTags.delete(value);
    }
    updatePrompt();

    const rows = tagContainer.querySelectorAll('tr');
    rows.forEach(row => {
        const checkbox = row.querySelector('input');
        if (checkbox && checkbox.dataset.value === value) {
            if (isChecked) row.classList.add('selected');
            else row.classList.remove('selected');
        }
    });
}

function updatePrompt() {
    if (selectedTags.size === 0) {
        promptDisplay.innerHTML = '<span class="placeholder">下のテーブルから項目を選択してプロンプトを作成してください...</span>';
        return;
    }
    const promptArray = Array.from(selectedTags);
    promptDisplay.textContent = promptArray.join(', ');
}

function setupEventListeners() {
    // Main Tabs
    tabBtns.forEach(btn => {
        btn.onclick = () => {
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMainCategory = btn.dataset.category;
            currentSubCategory = ''; // Reset sub-category
            renderSubTabs();
            renderRows();
        };
    });

    // Search
    searchInput.oninput = (e) => {
        searchQuery = e.target.value;
        renderRows();
    };

    // Copy Prompt
    copyBtn.onclick = () => {
        const text = promptDisplay.textContent;
        if (selectedTags.size > 0 && !text.includes('下のテーブルから')) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'コピー完了！';
                copyBtn.classList.add('success');
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('success');
                }, 2000);
            });
        }
    };

    // Clear All
    clearBtn.onclick = () => {
        selectedTags.clear();
        updatePrompt();
        renderRows();
    };

    // Copy Negative Prompt
    copyNegBtn.onclick = () => {
        navigator.clipboard.writeText(negPromptText.textContent).then(() => {
            copyNegBtn.textContent = 'コピー完了！';
            setTimeout(() => {
                copyNegBtn.textContent = 'Copy';
            }, 2000);
        });
    };
}

init();
